<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
  <title>地点关键字 + 公交路线规划</title>
  <style type="text/css">
    html,
    body,
    #container {
      width: 100%;
      height: 100%;
    }

    #panel {
      position: fixed;
      background-color: white;
      max-height: 90%;
      overflow-y: auto;
      top: 10px;
      right: 10px;
      width: 280px;
    }

    #panel .amap-call {
      background-color: #009cf9;
      border-top-left-radius: 4px;
      border-top-right-radius: 4px;
    }

    #panel .amap-lib-transfer {
      border-bottom-left-radius: 4px;
      border-bottom-right-radius: 4px;
      overflow: hidden;
    }
    header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .logout-btn {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .logout-btn:hover {
        background: rgba(255,255,255,0.3);
    }
    
    /* 新增样式 */
    .route-inputs {
        position: absolute;
        top: 80px;
        left: 10px;
        z-index: 100;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        width: 400px;
    }
    
    .input-group {
        margin-bottom: 15px;
        display: flex;
        align-items: center;
    }
    
    .input-group label {
        font-weight: bold;
        color: #333;
        margin-right: 10px;
        font-size: 16px;
        min-width: 60px;
    }
    
    .input-group input {
        flex: 1;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
        font-size: 16px;
    }
    
    .button-group {
        display: flex;
        gap: 10px;
    }
    
    .btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
    }
    
    .search-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .back-btn {
        background: #6c757d;
        color: white;
    }
  </style>
  <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css" />
    <script src="https://a.amap.com/jsapi_demos/static/demo-center/js/demoutils.js"></script>
    <script type="text/javascript"> 
        window._AMapSecurityConfig = {
            securityJsCode: "{{ amap_config.security_code }}",
        };
    </script>
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key={{ amap_config.web_api_key }}&plugin=AMap.Transfer,AMap.Adaptor "></script>
    <script type="text/javascript" src="https://cache.amap.com/lbs/static/addToolbar.js"></script>
    <script>
        // Firebase配置（从环境变量获取）
    const firebaseConfig = {
        apiKey: "{{ firebase_config.apiKey }}",
        authDomain: "{{ firebase_config.authDomain }}",
        projectId: "{{ firebase_config.projectId }}",
        storageBucket: "{{ firebase_config.storageBucket }}",
        messagingSenderId: "{{ firebase_config.messagingSenderId }}",
        appId: "{{ firebase_config.appId }}",
        measurementId: "{{ firebase_config.measurementId }}"
    };

        // 初始化Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // DOM元素
        const userEmail = document.getElementById('userEmail');
        auth.onAuthStateChanged(user => {
            if (user) {
                // 用户已登录，可以获取邮箱信息
                document.getElementById('userEmail').textContent = user.email;
            } else {
                // 用户未登录，重定向到登录页面
                window.location.href = '/';
            }
        });
    </script>
</head>
<body>
    <header>
    <h1>导航</h1>
    <div class="user-info">
        <span id="userEmail">用户邮箱</span>
        <button class="logout-btn" onclick="signOut()">退出登录</button>
    </div>
    </header>
    
    <!-- 路线输入框 -->
    <div class="route-inputs">
        <div class="input-group">
            <label for="startPoint">起点：</label>
            <input type="text" id="startPoint" placeholder="请输入起点位置">
        </div>
        <div class="input-group">
            <label for="endPoint">终点：</label>
            <input type="text" id="endPoint" placeholder="请输入终点位置">
        </div>
        <div class="button-group">
            <button class="btn search-btn" onclick="searchRoute()">搜索</button>
            <button class="btn back-btn" onclick="goBack()">返回</button>
        </div>
    </div>
    
  <div id="container"></div>
  <div id="panel"></div>
  <script type="text/javascript">
    var map = new AMap.Map("container", {
      resizeEnable: true,
      zoom: 13
    });
    //获取用户所在城市信息
    function showCityInfo() {
        //实例化城市查询类
        var citysearch = new AMap.CitySearch();
        //自动获取用户IP，返回当前城市
        citysearch.getLocalCity(function(status, result) {
            if (status === 'complete' && result.info === 'OK') {
                if (result && result.city && result.bounds) {
                    var cityinfo = result.city;
                    var citybounds = result.bounds;
                    document.getElementById('info').innerHTML = '您当前所在城市：'+cityinfo;
                    //地图显示当前城市
                    map.setBounds(citybounds);
                }
            } else {
                document.getElementById('info').innerHTML = result.info || '暂无数据';
            }
        });
    }
    // showCityInfo();
    var transOptions = {
      map: map,
      city: '南京市',
      panel: 'panel',
      policy: AMap.TransferPolicy.LEAST_TIME //乘车策略
    };
    //构造公交换乘类
    var transfer = new AMap.Transfer(transOptions);
    
    // 根据起、终点名称查询公交换乘路线的函数
    function searchRoute() {
        // 获取输入框中的起点和终点
        var startPoint = document.getElementById('startPoint').value;
        var endPoint = document.getElementById('endPoint').value;
        
        // 检查输入是否为空
        if (!startPoint || !endPoint) {
            alert('请输入起点和终点位置');
            return;
        }
        
        // 执行路线搜索
        transfer.search([
            { keyword: startPoint, city: '南京市' },
            { keyword: endPoint, city: '南京市' }
        ], function (status, result) {
            // result即是对应的公交路线数据信息，相关数据结构文档请参考  https://lbs.amap.com/api/javascript-api/reference/route-search#m_TransferResult
            if (status === 'complete') {
                log.success('绘制公交路线完成')
            } else {
                log.error('公交路线数据查询失败' + result)
            }
        });
    }
    
    // 返回用户主页
    function goBack() {
        window.location.href = '/userhome';
    }
    
    function signOut() {
        auth.signOut().then(() => {
            window.location.href = '/';
        });
    }
    
    
  </script>
</body>

</html>